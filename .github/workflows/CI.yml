name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-18.04
    # because: https://github.com/Qayme/qayme-action-cosmosdb-emulator
    # runs-on: ubuntu-latest

    services:
      cosmos:
        image: mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator
        ports:
          - 8081:8081
          - 10251:10251
          - 10252:10252
          - 10253:10253
          - 10254:10254
        env:
          AZURE_COSMOS_EMULATOR_PARTITION_COUNT: 10
          AZURE_COSMOS_EMULATOR_ENABLE_DATA_PERSISTENCE: false
        options: -m 3g --cpus=2.0
      
      sql:
       image: mcr.microsoft.com/mssql/server
       ports:
         - 1433:1433
       env:
         ACCEPT_EULA: Y
         SA_PASSWORD: sAPWD23.^0

    steps:
    - uses: actions/checkout@v2

    - name: Set EnvVar for Test
      run: |
        echo "ConnectionStrings__Database=Data Source=localhost,1433;Initial Catalog=My.Hr;User id=sa;Password=sAPWD23.^0;TrustServerCertificate=true" >> $GITHUB_ENV

    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: | 
          3.1.x
          6.0.x

    # - name: Restore dependencies
    #   run: dotnet restore
      
    # - name: Build
    #   run: dotnet build --no-restore
 
    # - name: Test
    #   run: dotnet test --filter "(TestCategory!=WithDB)&(TestCategory!=WithCosmos)" --no-build --verbosity normal /p:CollectCoverage=true /p:Exclude="[CoreEx.TestFunction]*" /p:CoverletOutputFormat=lcov /p:CoverletOutput=./coverage/lcov.info

    # - name: TestWithDB
    #   run: dotnet test --filter TestCategory=WithDB --no-build --verbosity normal /p:CollectCoverage=true /p:Exclude="[CoreEx.TestFunction]*" /p:CoverletOutputFormat=lcov /p:CoverletOutput=./coverage/lcov2.info

    - name: Cosmos Logs
      run: |
        docker ps --all
        curl -v -k https://localhost:8081/_explorer/emulator.pem > ~/emulatorcert.crt 

    - name: Test With Cosmos DB TestCategory=WithCosmos 
      run: dotnet test --filter Name=AsQueryable1 --no-build --verbosity normal /p:CollectCoverage=true /p:Exclude="[CoreEx.TestFunction]*" /p:CoverletOutputFormat=lcov /p:CoverletOutput=./coverage/lcov3.info
